# 谈谈你对Mutex包Lock的理解

## 1 正常模式

1.1 一堆协程抢这个锁， 都在自旋，抢到执行。假如超过一定次数没抢到（4次），就会去排队，FIFO。

1.2 当锁被释放，队头的协程被唤醒之后不会马上获得锁，需要和后来的协程（拿着自旋阶段的锁）去竞争。因为后来的协程往往更多，而且都在获得了CPU时间片正在运行，所以队头协程相对难抢到锁。

1.3 如果还是抢不到锁，队头协程又会加入等待队列的头部，等待下一次被唤醒的机会。

1.4 如果队头协程超过1ms抢不到锁，mutex就会进入饥饿模式。

## 2 饥饿模式

2.1 当前锁被释放，直接给队头的协程，队头协程拿到锁开始执行。

2.2 后来的协程不再自旋，大家自觉排队。就算当前锁为unlock，也不会去抢。

2.3 如果一个协程获得锁，而它在等待队列中没有超过1ms，这时候认为等待队列中协程数量不多，竞争不激烈，会从饥饿模式切换回正常模式。

2.4 如果一个协程是等待队列的最后一个，那么认为竞争不激烈，会从饥饿模式切换回正常模式。

## 3 好处

3.1 一开始竞争不激烈，可以不公平，大家自旋各凭本事，避免协程等待和唤醒，避免保存上下文和切换用户态内核态。

3.2 如果竞争激烈，防止协程饿死，开始FIFO获得锁，公平。

3.3 Mutex的状态切换减少了获取锁的开销，又保障了公平。