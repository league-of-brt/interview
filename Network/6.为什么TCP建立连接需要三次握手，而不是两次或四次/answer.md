# 为什么TCP建立连接需要三次握手，而不是两次或四次

* [为什么TCP建立连接需要三次握手，而不是两次或四次](#为什么tcp建立连接需要三次握手而不是两次或四次)
  * [1 错误的类比](#1-错误的类比)
  * [2 什么是 TCP 连接，TCP 连接需要什么？](#2-什么是-tcp-连接tcp-连接需要什么)
  * [3 为什么两次握手不行？](#3-为什么两次握手不行)
  * [4 为什么需要三次握手？为什么要这样设计？](#4-为什么需要三次握手为什么要这样设计)
    * [4\.1 历史连接问题（使用三次握手建立连接的最主要原因）](#41-历史连接问题使用三次握手建立连接的最主要原因)
    * [4\.2 初始序列号](#42-初始序列号)
    * [4\.3 一个疑问](#43-一个疑问)
  * [5 为什么不需要四次握手？](#5-为什么不需要四次握手)
  * [6 总结](#6-总结)
    * [6\.1 为什么不使用『两次握手』和『四次握手』？](#61-为什么不使用两次握手和四次握手)
    * [6\.2 为什么使用『三次握手』？](#62-为什么使用三次握手)

本文大致基于draveness的文章，直接使用示意图：https://draveness.me/whys-the-design-tcp-three-way-handshake/


## 1 错误的类比

一问起为什么 TCP 建立连接需要三次握手，很多人的回答都是这个：

> 1. 你听得到吗？
> 2. 我能听到，你听得到？
> 3. 我也能听到；

翻译过来就是：

> 1. 能收到我的请求吗？
> 2. 可以，能收到我的响应吗？
> 3. 可以，我们可以开始通信了；

![pic](https://brt-1303999354.cos.ap-shanghai.myqcloud.com/QQ%E6%88%AA%E5%9B%BE20210319015515.png)

个人认为，这个回答着重于阐述**发送方和接收方之间的连通性**，经过这么三次握手，发送方和接收方建立了连接上的互信：

> 1. 发送方确认了接收方能收到请求。
> 2. 发送方确认了自己能收到接收方的响应。
> 3. 接收方确认了自己能收到发送方的请求。
> 4. 接收方确认了发送方能收到响应。

这个类比不能算是不对，只能说表述得不全，因为 TCP 建立连接并不是确定了“连通性”就能了事，这个类比更像是用现象去掩盖了本质。

## 2 什么是 TCP 连接，TCP 连接需要什么？

首先我们要下个定义，什么是 TCP 连接？

RFC 793 - Transmission Control Protocol 文档中非常清楚地定义了 TCP 中的连接是什么：

> The reliability and flow control mechanisms described above require that TCPs initialize and maintain certain status information for each data stream. The combination of this information, including sockets, sequence numbers, and window sizes, is called a connection.

简单总结一下：

> **用于保证可靠性和流控制机制的信息，包括 Socket、序列号以及窗口大小叫做连接。**

这里强调了，连接需要：

> 1. Socket（由互联网地址标志符和端口组成的）；
>
> 2. 序列号（数据包的序号，接收方可以通过序列号向发送方确认某个数据包的成功接收）；
>
> 3. 窗口大小（用来做流控制）；

建立 TCP 连接就是通信的双方需要对上述的三种信息达成共识。

至此，问题变成了『为什么需要通过三次握手才可以初始化 Sockets、窗口大小和初始序列号？』，那么接下来我们就开始对这个细化的问题进行分析并寻找解释。

## 3 为什么两次握手不行？

如果只有两次握手，那就是通信双方的通信次数只有两次，那么发送方一旦发出建立连接的请求之后它就没有办法撤回这一次请求。

如果在网络状况复杂或者较差的网络中，想要建立连接，发送方可能会连续发送多次建立连接的请求。如果 TCP 建立连接只能通信两次，那么接收方只能选择接受或者拒绝发送方发起的请求，它并不清楚这一次请求是不是由于网络拥堵而早早过期的连接。

所以接收方就会非常痛苦，因为无法区分，所以无法历史连接，会建立起一堆没有的连接，浪费资源。

![pic](https://brt-1303999354.cos.ap-shanghai.myqcloud.com/QQ%E6%88%AA%E5%9B%BE20210319020325.png)

## 4 为什么需要三次握手？为什么要这样设计？

### 4.1 历史连接问题（使用三次握手建立连接的最主要原因）

我们可以想一想，接收方当然没有办法确定一个请求是否历史连接了，这种事情只有发送方知道：

发送方想要和接收方建立起一条连接，于是发送了 n 个请求，其中一条请求成功并且建立了连接，那么剩下的 n-1 都应该是历史连接。

所以，当接收方收到请求时，还得再询问发送方是否真的需要建立起一条请求。如果真的需要建立，那么发送方还得再确认一次。

> 所以，TCP 选择使用三次握手来建立连接并在连接引入了 RST 这一控制消息，接收方当收到请求时会将发送方发来的 SEQ+1 发送给对方，这时由发送方来判断当前连接是否是历史连接：
>
> 1. 如果当前连接是历史连接，即 SEQ 过期或者超时，那么发送方就会直接发送 RST 控制消息中止这一次连接；
>
> 2. 如果当前连接不是历史连接，那么发送方就会发送 ACK 控制消息，通信双方就会成功建立连接；

![pic](https://brt-1303999354.cos.ap-shanghai.myqcloud.com/tcp-recovery-from-old-duplicate-syn.png)

> 1. 图中，SEQ = 98 的请求就是历史连接，接收方收到请求后，ACK = SEQ+1 = 91，再次询问发送方是否要建立连接。
>
> 2. 发送方收到响应后，知道接收方在询问是否要确认建立连接。于是根据一定的规则（比较复杂，不展开讨论），判断这是一个历史请求，于是发送 RST 终止连接的建立。

使用三次握手和 RST 控制消息将是否建立连接的最终控制权交给了发送方，因为只有发送方有足够的上下文来判断当前连接是否是错误的或者过期的，这也是 TCP 使用三次握手建立连接的最主要原因。

### 4.2 初始序列号

另一个使用三次握手的重要的原因就是通信双方都需要获得一个用于发送信息的初始化序列号，作为一个可靠的传输层协议，TCP 需要在不稳定的网络环境中构建一个可靠的传输层，网络的不确定性可能会导致数据包的缺失和顺序颠倒等问题。

常见的问题可能包括：

> 1. 数据包被发送方多次发送造成数据的重复；
> 2. 数据包在传输的过程中被路由或者其他节点丢失；
> 3. 数据包到达接收方可能无法按照发送顺序；

为了解决上述这些可能存在的问题，TCP 协议要求发送方在数据包中加入『序列号』字段，有了数据包对应的序列号，我们就可以：

> 1. 接收方可以通过序列号对重复的数据包进行去重；
> 2. 发送方会在对应数据包未被 ACK 时进行重复发送；
> 3. 接收方可以根据数据包的序列号对它们进行重新排序；

序列号在 TCP 连接中有着非常重要的作用，初始序列号作为 TCP 连接的一部分也需要在三次握手期间进行初始化。

由于 TCP 连接通信的双方都需要获得初始序列号，所以它们其实需要向对方发送 SYN 控制消息并携带自己期望的初始化序列号 SEQ，对方在收到 SYN 消息之后会通过 ACK 控制消息以及 SEQ+1 来进行确认。

![pic](https://brt-1303999354.cos.ap-shanghai.myqcloud.com/basic-4-way-handshake.png)

由于 TCP 消息头的设计，可以将中间的两次通信合成一个，TCP B 可以向 TCP A 同时发送 ACK 和 SYN 控制消息，这也就帮助我们将四次通信减少至三次：

![pic](https://brt-1303999354.cos.ap-shanghai.myqcloud.com/basic-3-way-handshake.png)

如上图所示，通信双方的两个 TCP A/B 分别向对方发送 SYN 和 ACK 控制消息，等待通信双方都获取到了自己期望的初始化序列号之后就可以开始通信了：

简单总结一下（存疑）：

> **发送方接收方都要确认彼此的序列号，既然要确认，那就是一问一答。所以必须要三次握手。**

### 4.3 一个疑问

这里其实有个疑问，两次握手不是已经告知彼此的序列号了吗？为啥一定要第三次握手发个 ACK 让接收方确认一下？

如果缺少了第三次握手 ACK，会发生什么问题？

如果缺少了第三次握手的 ACK，那么接收方就无法知道发送方是否收到了自己的同步信号（即响应），那么彼此之间的初始序列号将无法达成一致。

如果发送方不同意接收方的初始序列号，那么发送方的请求就不是可信的。这种情况下就无法建立连接。

所以为了互信，发送方必须确认，进行第三次握手。

## 5 为什么不需要四次握手？

因为我们总可以使用更多的通信次数交换相同的信息，所以使用四次、五次或者更多次数建立连接在技术上都是完全可以实现的。

这不是能不能的问题，而是有没有必要的问题。

我们追求的其实是用更少的通信次数（理论上的边界）完成信息的交换，也就是为什么我们在上两节中也一再强调使用『两次握手』没有办法建立 TCP 连接，使用三次握手是建立连接所需要的最小次数。

## 6 总结

### 6.1 为什么不使用『两次握手』和『四次握手』？

> 1. 『两次握手』：无法避免历史错误连接的初始化，浪费接收方的资源；
>
> 2. 『四次握手』：TCP 协议的设计可以让我们同时传递 ACK 和 SYN 两个控制信息，减少了通信次数，所以不需要使用更多的通信次数传输相同的信息；

### 6.2 为什么使用『三次握手』？

> TCP 建立连接时通过三次握手可以有效地避免历史错误连接的建立，减少通信双方不必要的资源消耗，三次握手能够帮助通信双方获取初始化序列号，它们能够保证数据包传输的不重不丢，还能保证它们的传输顺序，不会因为网络传输的问题发生混乱。
